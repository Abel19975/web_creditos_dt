<div class="grid">
  <div class="overflow-x-hidden">
    <div class="card">
      <div class="card-header">
        <h3>Créditos</h3>
      </div>
      <div class="flex flex-col md:flex-row md:items-center md:justify-center gap-2 mb-2">
        <p-floatlabel variant="on">
          <p-datepicker
            [(ngModel)]="fechaInicio"
            inputId="fecha_inicio"
            showIcon
            iconDisplay="input"
            appendTo="body"
            size="small"
            dateFormat="dd/mm/yy"
            fluid
          />
          <label for="fecha_inicio">Fecha inicio</label>
        </p-floatlabel>
        <p-floatlabel variant="on">
          <p-datepicker
            [(ngModel)]="fechaFin"
            inputId="fecha_fin"
            showIcon
            iconDisplay="input"
            appendTo="body"
            size="small"
            dateFormat="dd/mm/yy"
            fluid
          />
          <label for="fecha_fin">Fecha fin</label>
        </p-floatlabel>
        <p-floatlabel variant="on">
          <p-autocomplete
            [dropdown]="true"
            [showClear]="true"
            [suggestions]="empleados()"
            (completeMethod)="buscarEmpleado($event)"
            size="small"
            appendTo="body"
            optionLabel="persona.nombre_completo"
            [(ngModel)]="empleadoSeleccionado"
            fluid
            inputId="empleado_id"
          />
          <label for="empleado_id">Empleado</label>
        </p-floatlabel>
        <p-floatlabel variant="on">
          <p-autocomplete
            [dropdown]="true"
            [showClear]="true"
            [suggestions]="clientes()"
            (completeMethod)="buscarCliente($event)"
            size="small"
            appendTo="body"
            optionLabel="persona.nombre_completo"
            [(ngModel)]="clienteSeleccionado"
            fluid
            inputId="cliente_id"
          />
          <label for="cliente_id">Cliente</label>
        </p-floatlabel>

        <p-floatlabel variant="on">
          <p-select
            [options]="estadoCreditos()"
            [(ngModel)]="estado"
            [showClear]="true"
            [checkmark]="true"
            appendTo="body"
            optionValue="valor"
            optionLabel="nombre"
            class="w-full md:w-56"
            size="small"
            inputId="estado"
          />

          <label for="estado">Estado</label>
        </p-floatlabel>
        <p-floatlabel variant="on">
          <p-select
            [options]="estadosRenovacion()"
            [showClear]="true"
            [checkmark]="true"
            appendTo="body"
            optionValue="valor"
            optionLabel="nombre"
            class="w-full md:w-56"
            size="small"
            inputId="estado_renovacion"
          />

          <label for="estado_renovacion">Estado renovación</label>
        </p-floatlabel>

        <p-button
          fluid
          size="small"
          icon="pi pi-search"
          pTooltip="Buscar"
          iconPos="right"
          (onClick)="aplicarFiltros()"
        />
        <p-button
          fluid
          size="small"
          severity="secondary"
          icon="pi pi-refresh"
          iconPos="right"
          pTooltip="Resetear"
          (onClick)="refrescar()"
        />
      </div>
      <br />

      <p-table
        #dt
        [value]="creditos()"
        [paginator]="true"
        [rows]="pagination().per_page"
        [totalRecords]="pagination().total"
        [first]="(pagination().current_page - 1) * pagination().per_page"
        [lazy]="true"
        (onLazyLoad)="onPageChange($event)"
        [scrollable]="true"
        [rowHover]="true"
        [sortOrder]="-1"
        dataKey="id"
        size="small"
      >
        <!-- header -->
        <ng-template #header>
          <tr>
            <th
              style="text-align: center"
              alignFrozen="left"
              pFrozenColumn
              class="dark:bg-slate-800! bg-primary-100!"
            >
              Acciones
            </th>
            <th class="dark:bg-slate-800! bg-primary-100!">Fecha</th>
            <th class="dark:bg-slate-800! bg-primary-100!">Cliente</th>
            <th class="dark:bg-slate-800! bg-primary-100!">Empleado</th>
            <th class="dark:bg-slate-800! bg-primary-100!">Secuencial</th>
            <th style="text-align: right" class="dark:bg-slate-800! bg-primary-100!">Crédito</th>
            <th style="text-align: right" class="dark:bg-slate-800! bg-primary-100!">Interes</th>
            <th style="text-align: right" class="dark:bg-slate-800! bg-primary-100!">Total</th>
            <th style="text-align: right" class="dark:bg-slate-800! bg-primary-100!">Pagado</th>
            <th style="text-align: right" class="dark:bg-slate-800! bg-primary-100!">Saldo</th>

            <th class="dark:bg-slate-800! bg-primary-100!" style="text-align: center">N° cuotas</th>

            <th style="text-align: right" class="dark:bg-slate-800! bg-primary-100!">
              Valor cuotas
            </th>
            <th style="text-align: right" class="dark:bg-slate-800! bg-primary-100!">
              Valor microseguro
            </th>

            <th style="text-align: center" class="dark:bg-slate-800! bg-primary-100!">
              Cuotas pagadas
            </th>
            <th style="text-align: center" class="dark:bg-slate-800! bg-primary-100!">
              Cuotas vencidas
            </th>
            <th style="text-align: center" class="dark:bg-slate-800! bg-primary-100!">
              Estado crédito
            </th>
            <th style="text-align: center" class="dark:bg-slate-800! bg-primary-100!">
              Estado renovación
            </th>
          </tr>
        </ng-template>

        <!-- body -->
        <ng-template #body let-credito>
          <tr>
            <td alignFrozen="left" pFrozenColumn class="dark:bg-slate-800! bg-primary-100!">
              <div class="flex justify-center gap-1">
                @if (credito.es_renovable && credito.puede_renovar) {
                  <p-button
                    icon="pi pi-refresh"
                    pTooltip="Renovar crédito por falta de pago"
                    severity="danger"
                    tooltipPosition="left"
                    label="Renovar"
                    size="small"
                    (click)="abrirCerrarModalRenovacion(credito)"
                  />
                }
                <p-button
                  icon="pi pi-eye"
                  class="w-full"
                  fluid
                  pTooltip="Ver reporte detallado"
                  tooltipPosition="left"
                  label="Ver"
                  severity="info"
                  (onClick)="descargarReporteDetallado(credito)"
                  size="small"
                />
              </div>
            </td>
            <td data-label="Fecha">
              {{ credito.fecha_credito | date: 'dd/MM/yyyy' }}
            </td>
            <td data-label="Cliente">
              {{ credito.cliente.persona.nombre_completo }}
            </td>
            <td data-label="Empleado">
              {{ credito.otorgante.nombre_completo }}
            </td>
            <td data-label="Secuencial">
              {{ credito.secuencial }}
            </td>
            <td data-label="Valor crédito" style="text-align: right">
              {{ credito.valor_credito | currency }}
            </td>
            <td data-label="Tasa interes" style="text-align: right">{{ credito.tasa_interes }}%</td>
            <td data-label="Total" style="text-align: right">
              {{ credito.total | currency }}
            </td>
            <td data-label="Total" style="text-align: right">
              {{ credito.pagado | currency }}
            </td>
            <td data-label="Total" style="text-align: right">
              {{ credito.saldo | currency }}
            </td>
            <td data-label="Número cuotas" style="text-align: center">
              {{ credito.numero_cuotas }}
            </td>

            <td data-label="Valor cuotas" style="text-align: right">
              {{ credito.valor_cuotas | currency }}
            </td>
            <td data-label="Valor microseguro" style="text-align: right">
              {{ credito.valor_micro_seguro | currency }}
            </td>

            <td data-label="Cuotas pagadas" style="text-align: center">
              {{ credito.cuotas_pagadas }}
            </td>
            <td data-label="Cuotas vencidas" style="text-align: center">
              <p-tag [severity]="severityCuotas(credito)" [value]="credito.cuotas_vencidas" />
            </td>
            <td data-label="Estado crédito" style="text-align: center">
              {{ credito.estado }}
            </td>

            <td data-label="Estado renovación" style="text-align: center">
              <p-tag
                [value]="
                  credito.estado === 'vigente' && credito.estado_renovacion === 'inactivo'
                    ? 'En proceso'
                    : credito.estado_renovacion
                "
                [severity]="
                  credito.estado === 'vigente' && credito.estado_renovacion === 'inactivo'
                    ? 'info'
                    : credito.estado_renovacion === 'inactivo'
                      ? 'danger'
                      : 'secondary'
                "
              />
            </td>
          </tr>
        </ng-template>
      </p-table>
    </div>
  </div>
</div>

<p-dialog
  header="Renovación de crédito"
  [modal]="true"
  [closable]="false"
  [(visible)]="modalValorRenovacion"
  [style]="{ width: '25rem' }"
>
  <span class="p-text-secondary"> N° {{ creditoSeleccionado()?.secuencial }} </span>
  <div class="flex justify-between mb-8">
    <span> Saldo </span>
    <span class="text-red-500 text-3xl">
      {{ creditoSeleccionado()?.saldo | currency }}
    </span>
  </div>
  <p-floatlabel variant="on">
    <p-inputnumber
      inputId="valor_credito"
      mode="currency"
      currency="USD"
      locale="en-US"
      size="small"
      fluid
      [formControl]="valorCredito"
      #valorCreditoInput
      [invalid]="esInvalidoControl()"
      [min]="convertToNumber(creditoSeleccionado()?.saldo)"
    />
    <label for="valor_credito">Valor renovación</label>
  </p-floatlabel>

  <div class="flex justify-end gap-2 mt-5">
    <p-button label="Cancelar" severity="secondary" (onClick)="abrirCerrarModalRenovacion()" />
    <p-button label="Renovar" (click)="renovarCredito()" />
  </div>
</p-dialog>
