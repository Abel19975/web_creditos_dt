<div class="grid">
  <div class="overflow-x-hidden">
    <div class="card">
      <div class="flex flex-col md:flex-row md:items-center justify-between mb-4">
        <div class="card-header">
          <h3>Saldo actual en cajas</h3>
        </div>
        <p-button
          (onClick)="abrirModalFormularioEgreso()"
          label="Registrar egreso"
          size="small"
          icon="pi pi-plus"
          fluid
          pTooltip="Registrar egreso"
        />
      </div>
      <p-table
        #dt
        [value]="saldoActuales()"
        [scrollable]="true"
        [rowHover]="true"
        dataKey="id"
        size="small"
        [scrollable]="true"
        scrollHeight="400px"
      >
        <!-- header -->
        <ng-template #header>
          <tr>
            <th class="dark:bg-slate-800! bg-primary-100!">Empleado</th>
            <th class="dark:bg-slate-800! bg-primary-100!" style="text-align: right">
              Caja anterior
            </th>
            <th class="dark:bg-slate-800! bg-primary-100!" style="text-align: right">Cobros</th>
            <th class="dark:bg-slate-800! bg-primary-100!" style="text-align: right">
              Microseguros
            </th>
            <th class="dark:bg-slate-800! bg-primary-100!" style="text-align: right">Créditos</th>
            <th class="dark:bg-slate-800! bg-primary-100!" style="text-align: right">
              Otros egresos
            </th>

            <th class="dark:bg-slate-800! bg-primary-100!" style="text-align: right">
              Total ingresos
            </th>
            <th class="dark:bg-slate-800! bg-primary-100!" style="text-align: right">
              Total egresos
            </th>

            <th
              style="text-align: right"
              alignFrozen="right"
              pFrozenColumn
              class="dark:bg-slate-800! bg-primary-100!"
            >
              Total caja
            </th>
            <th
              style="text-align: center"
              alignFrozen="right"
              pFrozenColumn
              class="dark:bg-slate-800! bg-primary-100!"
            >
              Acciones
            </th>
          </tr>
        </ng-template>

        <!-- body -->
        <ng-template #body let-historial>
          <tr>
            <td data-label="Empleado">
              {{ historial.empleado.persona.nombre_completo }}
            </td>
            <td data-label="Caja anterior" style="text-align: right">
              {{ historial.saldo_anterior | currency }}
            </td>
            <td data-label="Cobros" style="text-align: right">
              {{ historial.total_recaudado | currency }}
            </td>
            <td data-label="Microseguros" style="text-align: right">
              {{ historial.total_microseguro | currency }}
            </td>

            <td data-label="Créditos" style="text-align: right">
              {{ historial.total_desembolso | currency }}
            </td>
            <td data-label="Otros egresos" style="text-align: right">
              {{ historial.total_otros_egresos | currency }}
            </td>
            <td data-label="Total ingresos" style="text-align: right">
              {{ historial.total_ingresos | currency }}
            </td>
            <td data-label="Total egresos" style="text-align: right">
              <b>
                {{ historial.total_egresos | currency }}
              </b>
            </td>
            <td
              data-label="Total caja"
              alignFrozen="right"
              pFrozenColumn
              style="text-align: right"
              class="dark:bg-slate-800! bg-primary-100!"
            >
              <b>{{ historial.total_caja | currency }}</b>
            </td>
            <td
              data-label="Acciones"
              alignFrozen="right"
              pFrozenColumn
              style="text-align: right"
              class="dark:bg-slate-800! bg-primary-100!"
            >
              <p-button
                fluid
                label="Arquear"
                size="small"
                (click)="arquearCaja(historial.empleado)"
                [severity]="historial.arqueado ? 'warn' : 'success'"
                [pTooltip]="
                  historial.arqueado
                    ? 'Ya se ha registrado el arqueo de esta caja por el día de hoy!'
                    : ''
                "
                tooltipPosition="left"
              />
            </td>
          </tr>
        </ng-template>
      </p-table>
    </div>
  </div>
</div>
<br />

<!-- filtros -->
<div class="grid">
  <div class="overflow-x-hidden">
    <div class="card">
      <div class="flex flex-col md:flex-row justify-center gap-2 mb-2">
        <p-floatlabel variant="on">
          <p-datepicker
            [(ngModel)]="fechaInicio"
            inputId="fecha_inicio_picker"
            showIcon
            iconDisplay="input"
            appendTo="body"
            size="small"
            dateFormat="dd/mm/yy"
            fluid
          />
          <label for="fecha_inicio_picker">Fecha inicio</label>
        </p-floatlabel>
        <p-floatlabel variant="on">
          <p-datepicker
            [(ngModel)]="fechaFin"
            inputId="fecha_fin_picker"
            showIcon
            iconDisplay="input"
            appendTo="body"
            size="small"
            dateFormat="dd/mm/yy"
            fluid
          />
          <label for="fecha_fin_picker">Fecha fin</label>
        </p-floatlabel>
        <p-autocomplete
          [dropdown]="true"
          [suggestions]="empleados()"
          (completeMethod)="buscarEmpleado($event)"
          size="small"
          appendTo="body"
          optionLabel="persona.nombre_completo"
          placeholder="Buscar por empleado"
          [(ngModel)]="empleadoSeleccionado"
        />
        <p-button
          fluid
          size="small"
          icon="pi pi-search"
          iconPos="right"
          pTooltip="Buscar"
          (click)="cargarDatos()"
        />
        <p-button
          fluid
          size="small"
          severity="secondary"
          icon="pi pi-refresh"
          iconPos="right"
          pTooltip="Resetear"
          (onClick)="resetearFiltros()"
        />
      </div>
    </div>
  </div>
</div>
<br />

<div class="grid">
  <div class="overflow-x-hidden">
    <div class="card">
      <div class="card-header">
        <h3>Historial arqueos de cajas</h3>
      </div>
      <p-table
        #dt
        [value]="historial()"
        [scrollable]="true"
        [rowHover]="true"
        dataKey="id"
        size="small"
        scrollHeight="400px"
      >
        <!-- header -->
        <ng-template #header>
          <tr>
            <th class="dark:bg-slate-800! bg-primary-100!">Código</th>
            <th class="dark:bg-slate-800! bg-primary-100!">Fecha arqueo</th>
            <th class="dark:bg-slate-800! bg-primary-100!">Empleado</th>
            <th class="dark:bg-slate-800! bg-primary-100!" style="text-align: right">
              Saldo anterior
            </th>
            <th class="dark:bg-slate-800! bg-primary-100!" style="text-align: right">Cobros</th>
            <th class="dark:bg-slate-800! bg-primary-100!" style="text-align: right">
              Microseguros
            </th>

            <th class="dark:bg-slate-800! bg-primary-100!" style="text-align: right">Créditos</th>
            <th class="dark:bg-slate-800! bg-primary-100!" style="text-align: right">
              Otros egresos
            </th>

            <th class="dark:bg-slate-800! bg-primary-100!" style="text-align: right">
              Total ingresos
            </th>
            <th class="dark:bg-slate-800! bg-primary-100!" style="text-align: right">
              Total egresos
            </th>
            <th
              style="text-align: right"
              alignFrozen="right"
              pFrozenColumn
              class="dark:bg-slate-800! bg-primary-100!"
            >
              Total caja
            </th>
          </tr>
        </ng-template>

        <!-- body -->
        <ng-template #body let-historial>
          <tr>
            <td data-label="Código">
              {{ historial.id }}
            </td>
            <td data-label="Fecha arqueo">
              {{ historial.fecha_arqueo | date: 'dd/MM/yyyy' }}
            </td>
            <td data-label="Empleado">
              {{ historial.empleado.persona.nombre_completo }}
            </td>
            <td data-label="Saldo anterior" style="text-align: right">
              {{ historial.saldo_anterior | currency }}
            </td>
            <td data-label="Cobros" style="text-align: right">
              {{ historial.total_recaudado | currency }}
            </td>
            <td data-label="Microseguros" style="text-align: right">
              {{ historial.total_microseguro | currency }}
            </td>

            <td data-label="Créditos" style="text-align: right">
              {{ historial.total_desembolso | currency }}
            </td>
            <td data-label="Otros egresos" style="text-align: right">
              {{ historial.total_otros_egresos | currency }}
            </td>
            <td data-label="Total ingresos" style="text-align: right">
              {{ historial.total_ingresos | currency }}
            </td>
            <td data-label="Total egresos" style="text-align: right">
              {{ historial.total_egresos | currency }}
            </td>
            <td
              data-label="Total caja"
              alignFrozen="right"
              pFrozenColumn
              style="text-align: right"
              class="dark:bg-slate-800! bg-primary-100!"
            >
              {{ historial.total_caja | currency }}
            </td>
          </tr>
        </ng-template>

        <!-- footer -->
        <ng-template #footer>
          <tr
            class="bg-primary-50 dark:bg-slate-800 font-bold border-t-2 border-primary-200 dark:border-slate-700"
          >
            <td colspan="3" style="text-align: right" class="px-4 py-3">TOTALES</td>
            <td style="text-align: right" class="px-4 py-3">
              {{ totalesHistorial()?.saldo_anterior | currency }}
            </td>
            <td style="text-align: right" class="px-4 py-3">
              {{ totalesHistorial()?.total_recaudado | currency }}
            </td>
            <td style="text-align: right" class="px-4 py-3">
              {{ totalesHistorial()?.total_microseguro | currency }}
            </td>
            <td style="text-align: right" class="px-4 py-3">
              {{ totalesHistorial()?.total_ingresos | currency }}
            </td>
            <td style="text-align: right" class="px-4 py-3">
              {{ totalesHistorial()?.total_desembolso | currency }}
            </td>
            <td style="text-align: right" class="px-4 py-3">
              {{ totalesHistorial()?.total_otros_egresos | currency }}
            </td>
            <td style="text-align: right" class="px-4 py-3">
              {{ totalesHistorial()?.total_egresos | currency }}
            </td>
            <td style="text-align: right" alignFrozen="right" pFrozenColumn>
              {{ totalesHistorial()?.total_caja | currency }}
            </td>
          </tr>
        </ng-template>
      </p-table>
    </div>
  </div>
</div>
<br />

<div class="grid">
  <div class="overflow-x-hidden">
    <div class="card">
      <div class="card-header">
        <h3>Historial de movimientos</h3>
      </div>
      <p-table
        #dt
        [value]="movimientos()"
        [scrollable]="true"
        [rowHover]="true"
        dataKey="id"
        size="small"
        [scrollable]="true"
        scrollHeight="500px"
      >
        <!-- header -->
        <ng-template #header>
          <tr>
            <th class="dark:bg-slate-800! bg-primary-100!">Código</th>
            <th class="dark:bg-slate-800! bg-primary-100!">Fecha movimiento</th>
            <th class="dark:bg-slate-800! bg-primary-100!">Empleado</th>
            <th class="dark:bg-slate-800! bg-primary-100!">Tipo movimiento</th>
            <th class="dark:bg-slate-800! bg-primary-100!" style="text-align: right">Monto</th>
            <th class="dark:bg-slate-800! bg-primary-100!" style="text-align: right">Saldo</th>
            <th class="dark:bg-slate-800! bg-primary-100!">Descripción</th>
          </tr>
        </ng-template>

        <!-- body -->
        <ng-template #body let-historial>
          <tr>
            <td data-label="Código">
              {{ historial.id }}
            </td>
            <td data-label="Fecha movimiento">
              {{ historial.created_at | date: 'dd/MM/yyyy' }}
            </td>
            <td data-label="Empleado">
              {{ historial.empleado.persona.nombre_completo }}
            </td>
            <td data-label="Tipo movimiento">
              {{ historial.tipo }}
            </td>
            <td data-label="Monto" style="text-align: right">
              {{ historial.monto | currency }}
            </td>
            <td data-label="Saldo" style="text-align: right">
              {{ historial.saldo_resultante | currency }}
            </td>
            <td data-label="Descripción">
              {{ historial.descripcion }}
            </td>
          </tr>
        </ng-template>
      </p-table>
    </div>
  </div>
</div>

<p-dialog
  header="Registrar egreso"
  [modal]="true"
  [(visible)]="modal"
  [closable]="false"
  [style]="{ width: '40rem' }"
  [breakpoints]="{ '900px': '75vw', '575px': '90vw' }"
>
  <form [formGroup]="form" class="mt-3" (ngSubmit)="registrarEgreso()">
    <div class="grid grid-cols-12 gap-3">
      <div class="col-span-12 md:col-span-8">
        <div class="flex flex-col">
          <p-autocomplete
            [dropdown]="true"
            [suggestions]="empleados()"
            [invalid]="esInvalido('empleado_id')"
            (completeMethod)="buscarEmpleado($event)"
            formControlName="empleado_id"
            optionValue="persona_id"
            size="small"
            appendTo="body"
            optionLabel="persona.nombre_completo"
            placeholder="Buscar por empleado"
            fluid
          />
          @if (esInvalido('empleado_id')) {
            <p-message severity="error" variant="simple" size="small">
              @if (getControl('empleado_id').hasError('required')) {
                Ingrese el valor del egreso
              }
            </p-message>
          }
        </div>
      </div>
      <div class="col-span-12 md:col-span-4">
        <div class="flex flex-col">
          <p-floatlabel variant="on">
            <p-inputnumber
              [invalid]="esInvalido('monto')"
              formControlName="monto"
              inputId="monto"
              mode="currency"
              currency="USD"
              locale="en-US"
              size="small"
              fluid
            />
            <label for="monto">Valor de egreso</label>
          </p-floatlabel>
          @if (esInvalido('monto')) {
            <p-message severity="error" variant="simple" size="small">
              @if (getControl('monto').hasError('required')) {
                Ingrese el valor del egreso
              }
            </p-message>
          }
        </div>
      </div>
      <div class="col-span-12">
        <div class="flex flex-col">
          <p-floatlabel variant="on">
            <textarea
              formControlName="descripcion"
              rows="2"
              cols="30"
              pTextarea
              fluid
              [autoResize]="true"
              [invalid]="esInvalido('descripcion')"
            ></textarea>
            <label for="on_label">Descripción</label>
          </p-floatlabel>
          @if (esInvalido('descripcion')) {
            <p-message severity="error" variant="simple" size="small">
              @if (getControl('descripcion').hasError('required')) {
                Ingrese una descripción
              }
            </p-message>
          }
        </div>
      </div>
    </div>

    <!-- Botones de Acción -->
    <div class="flex justify-end gap-2 mt-6 pt-4 border-t border-gray-600">
      <p-button
        size="small"
        label="Cancelar"
        severity="secondary"
        (onClick)="cerrarModalFormularioEgreso()"
      />
      <p-button size="small" type="submit" label="Guardar" [disabled]="form.invalid" />
    </div>
  </form>
</p-dialog>
