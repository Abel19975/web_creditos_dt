<div class="grid">
  <div class="overflow-x-hidden">
    <div class="card">
      <div class="card-header">
        <div class="flex flex-col">
          <h3>Empleados</h3>
          <p>Crea, edita, elimina, desactiva tus empleados</p>
        </div>
        <p-button
          (onClick)="abrirModalFormulario()"
          size="small"
          pTooltip="Nuevo empleado"
          tooltipPosition="left"
          icon="pi pi-plus"
          label="Nuevo"
        />
      </div>

      <p-table
        #dt
        [value]="empleados()"
        [scrollable]="true"
        [rowHover]="true"
        [sortOrder]="-1"
        dataKey="id"
        size="small"
      >
        <!-- header -->
        <ng-template #header>
          <tr>
            <th class="dark:bg-slate-800! bg-primary-100!">Código</th>
            <th class="dark:bg-slate-800! bg-primary-100!">Nombres</th>
            <th class="dark:bg-slate-800! bg-primary-100!">Apellidos</th>
            <th class="dark:bg-slate-800! bg-primary-100!">Celular</th>
            <th class="dark:bg-slate-800! bg-primary-100!">Dirección</th>
            <th style="text-align: right" class="dark:bg-slate-800! bg-primary-100!">
              Tot.desembolsado
            </th>
            <th style="text-align: right" class="dark:bg-slate-800! bg-primary-100!">
              Tot.recaudar
            </th>
            <th style="text-align: right" class="dark:bg-slate-800! bg-primary-100!">
              Tot.recaudado
            </th>
            <th style="text-align: right" class="dark:bg-slate-800! bg-primary-100!">
              Tot.faltante
            </th>
            <th style="text-align: right" class="dark:bg-slate-800! bg-primary-100!">Tot.caja</th>
            <th
              style="text-align: right"
              alignFrozen="right"
              pFrozenColumn
              class="dark:bg-slate-800! bg-primary-100!"
            >
              Acciones
            </th>
          </tr>
        </ng-template>

        <!-- body -->
        <ng-template #body let-empleado>
          <tr>
            <td data-label="Código">
              {{ empleado.persona.id }}
            </td>
            <td data-label="Nombres">
              {{ empleado.persona.nombres }}
            </td>
            <td data-label="Apellidos">
              {{ empleado.persona.apellidos }}
            </td>
            <td data-label="Celular">
              {{ empleado.persona.celular }}
            </td>
            <td data-label="Dirección">
              {{ empleado.persona.direccion }}
            </td>

            <td data-label="Total desembolsado" style="text-align: right">
              {{ empleado.totales.total_capital_otorgado | currency }}
            </td>
            <td data-label="Total por recaudar" style="text-align: right">
              {{ empleado.totales.total_a_recaudar | currency }}
            </td>
            <td data-label="Total recaudado" style="text-align: right">
              {{ empleado.totales.total_recaudado | currency }}
            </td>
            <td data-label="Total faltante" style="text-align: right">
              {{ empleado.totales.total_faltante | currency }}
            </td>
            <td data-label="Total caja" style="text-align: right">
              {{ empleado.totales.valor_caja | currency }}
            </td>
            <td alignFrozen="right" pFrozenColumn>
              <div class="flex justify-end gap-1">
                <p-button
                  pTooltip="Editar"
                  tooltipPosition="left"
                  icon="pi pi-pen-to-square"
                  rounded
                  text
                  (onClick)="seleccionarParaEditar(empleado)"
                />
                <p-button
                  (onClick)="eliminarEmpleado(empleado)"
                  [pTooltip]="
                    !empleado.puede_eliminar
                      ? 'No se puede eliminar este empleado, mantiene registros importantes de los créditos'
                      : 'Eliminar'
                  "
                  tooltipPosition="left"
                  [disabled]="!empleado.puede_eliminar"
                  icon="pi pi-trash"
                  severity="danger"
                  rounded
                  text
                />
              </div>
            </td>
          </tr>
        </ng-template>
      </p-table>
    </div>
  </div>
</div>

<p-dialog
  header="Guardar empleado"
  [modal]="true"
  [(visible)]="modal"
  [closable]="false"
  [style]="{ width: '40rem' }"
  [breakpoints]="{ '900px': '75vw', '575px': '90vw' }"
>
  <form [formGroup]="form" class="mt-3" (ngSubmit)="guardar()">
    <div class="grid grid-cols-12 gap-3">
      <div class="col-span-12 md:col-span-6">
        <div class="flex flex-col">
          <p-floatlabel variant="on">
            <input
              formControlName="identificacion"
              pInputText
              id="identificacion"
              autocomplete="off"
              class="w-full"
              pSize="small"
              type="tel"
              (input)="utilSvc.soloNumeros($event)"
            />
            <label for="identificacion">Identificación</label>
          </p-floatlabel>
          @if (esInvalido('identificacion')) {
            <p-message severity="error" variant="simple" size="small">
              @if (getControl('identificacion').hasError('required')) {
                Ingresar la identificación
              }
            </p-message>
          }
        </div>
      </div>

      <div class="col-span-12 md:col-span-6">
        <div class="flex flex-col">
          <p-floatlabel variant="on">
            <input
              formControlName="celular"
              pInputText
              id="celular"
              autocomplete="off"
              class="w-full"
              pSize="small"
              type="tel"
              (input)="utilSvc.soloNumeros($event)"
            />
            <label for="celular">Celular</label>
          </p-floatlabel>
          @if (esInvalido('celular')) {
            <p-message severity="error" variant="simple" size="small">
              @if (getControl('celular').hasError('required')) {
                Ingresar el celular
              }
            </p-message>
          }
        </div>
      </div>

      <div class="col-span-12 md:col-span-6">
        <div class="flex flex-col">
          <p-floatlabel variant="on">
            <input
              formControlName="nombres"
              pInputText
              id="nombres"
              autocomplete="off"
              class="w-full"
              pSize="small"
            />
            <label for="nombres">Nombres</label>
          </p-floatlabel>
          @if (esInvalido('nombres')) {
            <p-message severity="error" variant="simple" size="small">
              @if (getControl('nombres').hasError('required')) {
                Ingresar los nombres
              }
            </p-message>
          }
        </div>
      </div>

      <div class="col-span-12 md:col-span-6">
        <div class="flex flex-col">
          <p-floatlabel variant="on">
            <input
              formControlName="apellidos"
              pInputText
              id="apellidos"
              autocomplete="off"
              class="w-full"
              pSize="small"
            />
            <label for="apellidos">Apellidos</label>
          </p-floatlabel>
          @if (esInvalido('apellidos')) {
            <p-message severity="error" variant="simple" size="small">
              @if (getControl('apellidos').hasError('required')) {
                Ingresar los apellidos
              }
            </p-message>
          }
        </div>
      </div>

      <div class="col-span-12">
        <div class="flex flex-col">
          <p-floatlabel variant="on">
            <input
              formControlName="direccion"
              pInputText
              id="direccion"
              autocomplete="off"
              class="w-full"
              pSize="small"
            />
            <label for="direccion">Dirección</label>
          </p-floatlabel>
          @if (esInvalido('direccion')) {
            <p-message severity="error" variant="simple" size="small">
              @if (getControl('direccion').hasError('required')) {
                Ingresar la dirección
              }
            </p-message>
          }
        </div>
      </div>

      @if (!mostrarOtrosCampos()) {
        <div class="col-span-12">
          <h3 class="text-sm font-semibold text-gray-600">Credenciales de Acceso</h3>
        </div>
        <div class="col-span-12 md:col-span-6">
          <div class="flex flex-col">
            <p-floatlabel variant="on">
              <input
                formControlName="username"
                pInputText
                id="username"
                autocomplete="off"
                class="w-full"
                pSize="small"
              />
              <label for="username">Nombre de usuario</label>
            </p-floatlabel>
            @if (esInvalido('username')) {
              <p-message severity="error" variant="simple" size="small">
                @if (getControl('username').hasError('required')) {
                  Ingresar el nombre de usuario
                }
              </p-message>
            }
          </div>
        </div>

        <div class="col-span-12 md:col-span-6">
          <div class="flex flex-col">
            <p-floatlabel variant="on">
              <input
                formControlName="password"
                pInputText
                id="password"
                type="password"
                autocomplete="off"
                class="w-full"
                pSize="small"
              />
              <label for="password">Contraseña</label>
            </p-floatlabel>
            @if (esInvalido('password')) {
              <p-message severity="error" variant="simple" size="small">
                @if (getControl('password').hasError('required')) {
                  Ingresar la contraseña
                }
              </p-message>
            }
          </div>
        </div>

        <div class="col-span-12 md:col-span-6">
          <div class="flex flex-col">
            <p-floatlabel variant="on">
              <p-inputnumber
                formControlName="valor_caja"
                inputId="valor_caja"
                mode="currency"
                currency="USD"
                locale="en-US"
                size="small"
                fluid
              />
              <label for="valor_caja">Valor caja anterior</label>
            </p-floatlabel>
            @if (esInvalido('valor_caja')) {
              <p-message severity="error" variant="simple" size="small">
                @if (getControl('valor_caja').hasError('required')) {
                  Ingresar el valor de la caja anterior
                }
              </p-message>
            }
          </div>
        </div>
      }
    </div>

    <!-- Botones de Acción -->
    <div class="flex justify-end gap-2 mt-6 pt-4 border-t border-gray-600">
      <p-button
        size="small"
        label="Cancelar"
        severity="secondary"
        (onClick)="cerrarModalFormulario()"
      />
      <p-button size="small" type="submit" label="Guardar" [disabled]="form.invalid" />
    </div>
  </form>
</p-dialog>
